<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYTHAVA | Admin Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #d1d5db; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .border-main { border-color: #1f2937; }
        .sidebar-item { transition: all 0.2s; border-left: 2px solid transparent; color: #64748b; }
        .sidebar-item.active { border-left: 2px solid #3b82f6; background-color: #0f172a; color: white; }
        .input-field { background-color: #0a0a0a; border: 1px solid #1f2937; color: white; padding: 10px 14px; border-radius: 6px; outline: none; font-size: 14px; transition: border 0.2s; }
        .input-field:focus { border-color: #3b82f6; }
        .admin-table th { font-family: 'JetBrains Mono'; font-size: 11px; text-transform: uppercase; color: #475569; padding: 12px; text-align: left; border-bottom: 1px solid #1f2937; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #111827; font-size: 13px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #1f2937; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="border-b border-main sticky top-0 bg-[#0a0a0a]/90 backdrop-blur-md z-50 px-6 h-16 flex items-center justify-between">
        <div class="flex-1"><a href="/" class="text-white font-extrabold text-xl tracking-tighter">PYTHAVA <span class="text-blue-500 text-xs ml-2 mono uppercase tracking-widest">Administrator</span></a></div>
        <div class="flex-1 flex justify-end">
            <button onclick="handleLogout()" class="text-[10px] mono text-gray-600 hover:text-white border border-main px-3 py-1 rounded">EXIT_SESSION</button>
        </div>
    </nav>

    <div class="flex flex-1 max-w-7xl mx-auto w-full">
        <aside class="w-64 border-r border-main p-6 hidden md:block">
            <nav class="space-y-1">
                <button onclick="showSection('user')" id="menu-user" class="sidebar-item active w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3">01. USER_MGMT</button>
                <button onclick="showSection('blog')" id="menu-blog" class="sidebar-item w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3">02. BLOG_MGMT</button>
                <button onclick="showSection('wargame')" id="menu-wargame" class="sidebar-item w-full text-left px-4 py-3 text-sm font-bold flex items-center gap-3">03. WAR_MGMT</button>
            </nav>
        </aside>

        <main class="flex-1 p-8">
            
            <section id="section-user">
                <h2 class="text-sm font-bold text-gray-500 mb-6 mono uppercase tracking-widest">// User_Database</h2>
                <div class="border border-main rounded-lg overflow-hidden bg-[#0a0a0a]">
                    <table class="w-full admin-table">
                        <thead><tr><th>Identifier</th><th>Joined</th><th>Status</th><th>Control</th></tr></thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
            </section>

            <section id="section-blog" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="border border-main p-6 rounded-xl bg-[#0a0a0a]">
                        <h3 class="text-xs font-bold text-blue-500 mb-6 mono uppercase tracking-widest">Create New Post</h3>
                        <form id="blog-form" class="flex flex-col gap-4">
                            <div class="flex gap-3">
                                <select id="blog-category" class="input-field flex-1">
                                    <option value="Write-up">Write-up</option>
                                    <option value="Log">Log</option>
                                </select>
                                <input type="text" id="blog-author" placeholder="Author" class="input-field w-32" value="Admin">
                            </div>
                            <input type="text" id="blog-title" placeholder="Post Title" class="input-field" required>
                            <input type="text" id="blog-tags" placeholder="Tags (e.g. #pwn #web)" class="input-field">
                            <textarea id="blog-content" placeholder="Content (Markdown/HTML)" rows="10" class="input-field" required></textarea>
                            <button type="submit" class="bg-blue-600 text-white py-3 rounded font-bold text-xs uppercase tracking-widest hover:bg-blue-500 transition-all">Publish</button>
                        </form>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 mb-4 mono uppercase">Archive List</h3>
                        <div id="blog-list" class="space-y-2 max-h-[600px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </section>

            <section id="section-wargame" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="border border-main p-6 rounded-xl bg-[#0a0a0a]">
                        <h3 class="text-xs font-bold text-emerald-500 mb-6 mono uppercase tracking-widest">Deploy Challenge</h3>
                        <form id="wargame-form" class="flex flex-col gap-4">
                            <input type="text" id="wg-title" placeholder="Challenge Title" class="input-field" required>
                            <input type="text" id="wg-tags" placeholder="Tags (e.g. #rev #crypto)" class="input-field">
                            <select id="wg-difficulty" class="input-field">
                                <option value="1">Level 1 - Easy</option>
                                <option value="2">Level 2 - Normal</option>
                                <option value="3">Level 3 - Medium</option>
                                <option value="4">Level 4 - Hard</option>
                                <option value="5">Level 5 - Insane</option>
                            </select>
                            <textarea id="wg-desc" placeholder="Challenge Description" rows="4" class="input-field" required></textarea>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="text" id="wg-flag" placeholder="Flag: PT{...}" class="input-field" required>
                                <input type="number" id="wg-points" placeholder="Points" class="input-field" required>
                            </div>
                            <button type="submit" class="bg-emerald-600 text-white py-3 rounded font-bold text-xs uppercase tracking-widest hover:bg-emerald-500 transition-all">Add Challenge</button>
                        </form>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-gray-500 mb-4 mono uppercase">Live Challenges</h3>
                        <div id="wargame-list" class="space-y-2 max-h-[600px] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const SB_URL = "https://udcsxjtnnrxolwmavyqo.supabase.co";
        const SB_KEY = "sb_publishable_q_NjT8knSzwiL7TOOajWYg_5FN1zIZp";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        function showSection(name) {
            ['user', 'blog', 'wargame'].forEach(s => {
                document.getElementById('section-' + s).classList.add('hidden');
                document.getElementById('menu-' + s).classList.remove('active');
            });
            document.getElementById('section-' + name).classList.remove('hidden');
            document.getElementById('menu-' + name).classList.add('active');
            
            if(name === 'wargame') fetchWargames();
            if(name === 'blog') fetchBlogs();
            if(name === 'user') fetchUsers();
        }

        // --- BLOG LOGIC ---
        document.getElementById('blog-form').onsubmit = async (e) => {
            e.preventDefault();
            const { error } = await _supabase.from('posts').insert([{
                title: document.getElementById('blog-title').value,
                content: document.getElementById('blog-content').value,
                tags: document.getElementById('blog-tags').value,
                category: document.getElementById('blog-category').value,
                author: document.getElementById('blog-author').value
            }]);
            if(error) alert(error.message); else { alert("Post Published!"); fetchBlogs(); e.target.reset(); }
        };

        async function fetchBlogs() {
            const { data } = await _supabase.from('posts').select('*').order('id', {ascending: false});
            document.getElementById('blog-list').innerHTML = data.map(p => `
                <div class="border border-main p-4 rounded bg-[#0a0a0a] flex justify-between items-center group">
                    <div>
                        <span class="text-[10px] mono text-blue-500 font-bold uppercase">[${p.category}]</span>
                        <h4 class="text-white text-sm font-bold">${p.title}</h4>
                        <p class="text-[10px] text-gray-600 mono">by ${p.author} | ${p.tags}</p>
                    </div>
                    <button onclick="deleteData('posts', ${p.id})" class="text-gray-700 hover:text-red-500 px-2">×</button>
                </div>
            `).join('');
        }

        // --- WARGAME LOGIC ---
        document.getElementById('wargame-form').onsubmit = async (e) => {
            e.preventDefault();
            const { error } = await _supabase.from('challenges').insert([{
                title: document.getElementById('wg-title').value,
                tags: document.getElementById('wg-tags').value,
                difficulty: parseInt(document.getElementById('wg-difficulty').value),
                description: document.getElementById('wg-desc').value,
                flag: document.getElementById('wg-flag').value,
                points: parseInt(document.getElementById('wg-points').value)
            }]);
            if(error) alert(error.message); else { alert("Challenge Deployed!"); fetchWargames(); e.target.reset(); }
        };

        async function fetchWargames() {
            const { data } = await _supabase.from('challenges').select('*').order('id', {ascending: false});
            document.getElementById('wargame-list').innerHTML = data.map(wg => `
                <div class="border border-main p-4 rounded bg-[#0a0a0a] flex justify-between items-center">
                    <div>
                        <p class="text-[10px] mono text-emerald-500 font-bold">LV.${wg.difficulty} | SOLVERS: ${wg.solvers_count || 0}</p>
                        <h4 class="text-white text-sm font-bold">${wg.title}</h4>
                        <p class="text-[10px] text-gray-600 mono">${wg.tags}</p>
                    </div>
                    <button onclick="deleteData('challenges', ${wg.id})" class="text-gray-700 hover:text-red-500 px-2">×</button>
                </div>
            `).join('');
        }

        // --- COMMON LOGIC ---
        async function deleteData(table, id) {
            if(confirm(`Remove from ${table}?`)) {
                const { error } = await _supabase.from(table).delete().eq('id', id);
                if(error) alert(error.message);
                table === 'posts' ? fetchBlogs() : fetchWargames();
            }
        }

        function handleLogout() { _supabase.auth.signOut().then(() => location.href='/login'); }
        
        // 초기 로딩
        showSection('user');
        // 페이지가 열리자마자 실행되어야 함
        async function init() {
            const { data: { user } } = await _supabase.auth.getUser();
            const navAuth = document.getElementById('nav-auth-section');
        
            if (user) {
                // 유저 정보가 있으면 'LOG IN' 버튼 대신 닉네임 표시
                const { data: profile } = await _supabase
                    .from('profiles')
                    .select('nickname')
                    .eq('id', user.id)
                    .single();
        
                navAuth.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-white text-[11px] font-bold mono">${profile?.nickname || 'USER'}</span>
                        <button id="logout-btn" class="text-[10px] text-gray-600 hover:text-white underline">LOGOUT</button>
                    </div>
                `;
        
                document.getElementById('logout-btn').onclick = async () => {
                    await _supabase.auth.signOut();
                    location.reload();
                };
            }
        }
        init();
    </script>
</body>
</html>
