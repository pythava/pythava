<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYTHAVA | Wargame Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #d1d5db; overflow-y: scroll; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .border-main { border-color: #1f2937; }
        
        .tab-btn { position: relative; transition: 0.3s; color: #6b7280; font-family: 'JetBrains Mono'; }
        .tab-btn.active { color: #ffffff; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -10px; left: 0; width: 100%; height: 2px; background: #10b981; }

        /* 문제 카드 기본 설정 */
        .challenge-card { 
            aspect-ratio: 3 / 1.5; 
            transition: all 0.4s ease; 
            border: 1px solid #1f2937; 
            cursor: pointer; 
            position: relative; 
            background: #0a0a0a;
            z-index: 1;
        }

        /* [핵심] 푼 문제 테두리 회전 애니메이션 */
        .solved-glow::before {
            content: '';
            position: absolute;
            top: -1px; left: -1px; right: -1px; bottom: -1px;
            background: conic-gradient(from 0deg, transparent 70%, #10b981 100%);
            border-radius: inherit;
            animation: rotate-border 2s linear infinite;
            z-index: -1;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            padding: 2px; /* 테두리 두께 */
        }

        @keyframes rotate-border {
            to { transform: rotate(360deg); }
        }

        /* 푼 문제 카드의 은은한 내부 광채 */
        .solved-glow {
            border-color: transparent !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
            background: linear-gradient(145deg, #0a0a0a, #061f18) !important;
        }

        .challenge-card:hover { transform: translateY(-5px); border-color: #10b981; }

        .content-box { background-color: #0a0a0a; border: 1px solid #1f2937; }
        .input-field { background-color: #0f0f0f; border: 1px solid #1f2937; color: white; outline: none; }
        .hidden { display: none; }
    </style>
</head>
<body class="selection:bg-emerald-500/30">

    <div class="h-1 w-full bg-gradient-to-r from-emerald-600 via-teal-500 to-transparent"></div>

    <nav class="border-b border-main sticky top-0 bg-[#0a0a0a]/80 backdrop-blur-md z-50">
        <div class="max-w-5xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex-1"><a href="/" class="text-white font-extrabold tracking-tighter text-xl italic">PYTHAVA</a></div>
            <div class="flex-[2] flex justify-center">
                <ul class="flex items-center gap-10 text-[12px] font-bold text-gray-500 uppercase tracking-[0.2em] mono">
                    <li><a href="/wargame" class="text-white">Wargame</a></li>
                    <li><a href="/blog" class="hover:text-white transition-colors">Blog</a></li>
                    <li><a href="/tools" class="hover:text-white transition-colors">Tools</a></li>
                </ul>
            </div>
            <div class="flex-1 flex justify-end" id="nav-auth-section">
                <button onclick="location.href='/login'" class="text-[11px] font-bold text-gray-400 border border-main px-4 py-1.5 rounded mono tracking-tighter">LOG IN</button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-6 mt-12">
        <div class="flex gap-8 border-b border-main pb-2 mb-12">
            <button onclick="switchTab('challenge')" id="tab-challenge" class="tab-btn active text-sm font-black uppercase tracking-widest italic">Challenge</button>
            <button onclick="switchTab('ranking')" id="tab-ranking" class="tab-btn text-sm font-black uppercase tracking-widest italic">Ranking</button>
        </div>
    </div>

    <main id="challenge-view" class="max-w-6xl mx-auto px-6 pb-20">
        <div id="challenge-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </main>

    <main id="ranking-view" class="max-w-4xl mx-auto px-6 pb-20 hidden">
        <div class="content-box overflow-hidden rounded-lg">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="border-b border-main bg-[#0f0f0f]">
                        <th class="px-8 py-4 text-[10px] mono text-gray-500 uppercase tracking-widest font-bold">Rank</th>
                        <th class="px-8 py-4 text-[10px] mono text-gray-500 uppercase tracking-widest font-bold">Researcher</th>
                        <th class="px-8 py-4 text-[10px] mono text-gray-500 uppercase tracking-widest font-bold text-right">Points</th>
                    </tr>
                </thead>
                <tbody id="ranking-body"></tbody>
            </table>
        </div>
    </main>

    <main id="detail-view" class="max-w-6xl mx-auto px-6 py-4 hidden">
        <button onclick="switchTab('challenge')" class="text-[10px] mono text-gray-600 hover:text-emerald-500 mb-8 uppercase tracking-widest">← Back to Terminal</button>
        <div id="detail-content-area"></div> 
    </main>

    <script>
        const SB_URL = "https://udcsxjtnnrxolwmavyqo.supabase.co";
        const SB_KEY = "sb_publishable_q_NjT8knSzwiL7TOOajWYg_5FN1zIZp";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        let currentChallenge = null;

        async function switchTab(tab) {
            document.getElementById('challenge-view').classList.add('hidden');
            document.getElementById('ranking-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            if (tab === 'challenge') {
                document.getElementById('challenge-view').classList.remove('hidden');
                document.getElementById('tab-challenge').classList.add('active');
                await fetchChallenges();
            } else if (tab === 'ranking') {
                document.getElementById('ranking-view').classList.remove('hidden');
                document.getElementById('tab-ranking').classList.add('active');
                await fetchRanking();
            }
        }

        async function fetchChallenges() {
            const { data: { user } } = await _supabase.auth.getUser();
            
            if (user) {
                const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
                document.getElementById('nav-auth-section').innerHTML = `
                    <div class="flex items-center gap-4 mono text-[11px]">
                        <div class="text-right"><div class="text-white font-bold">${profile.nickname.toUpperCase()}</div><div class="text-emerald-500 font-bold">${profile.points} PT</div></div>
                    </div>`;
            }

            let solvedIds = [];
            if (user) {
                const { data: logs } = await _supabase.from('solvers_log').select('challenge_id').eq('user_id', user.id);
                solvedIds = logs ? logs.map(l => l.challenge_id) : [];
            }

            const { data: challenges } = await _supabase.from('challenges').select('*').order('created_at', { ascending: false });
            const grid = document.getElementById('challenge-grid');
            
            grid.innerHTML = challenges.map(item => {
                const isSolved = solvedIds.includes(item.id);
                return `
                <div onclick="showDetail('${item.id}')" class="challenge-card p-8 flex flex-col justify-between group ${isSolved ? 'solved-glow' : ''}">
                    <div>
                        <div class="flex justify-between items-start mb-6">
                            <span class="text-[10px] mono font-bold px-2 py-0.5 border ${isSolved ? 'border-emerald-500 text-emerald-500' : 'border-emerald-500/30 text-emerald-500/60'} uppercase tracking-widest italic">
                                ${isSolved ? 'BREACHED' : item.category}
                            </span>
                            <span class="text-[10px] mono text-gray-600 font-bold">${item.level}</span>
                        </div>
                        <h3 class="text-xl font-bold text-white group-hover:text-emerald-400 transition-colors tracking-tighter uppercase italic">${item.title}</h3>
                    </div>
                    <div class="flex justify-between items-end border-t border-main pt-4 mt-4">
                        <span class="text-[9px] mono text-gray-700 uppercase">Solvers: ${item.solvers || 0}</span>
                        <span class="text-sm font-black text-white mono">${item.points} PT</span>
                    </div>
                </div>`;
            }).join('');
        }

        async function showDetail(id) {
            const { data: chal } = await _supabase.from('challenges').select('*').eq('id', id).single();
            const { data: { user } } = await _supabase.auth.getUser();
            
            let isSolved = false;
            if (user) {
                const { data: solved } = await _supabase.from('solvers_log').select('*').eq('user_id', user.id).eq('challenge_id', id).single();
                if (solved) isSolved = true;
            }

            currentChallenge = chal;
            document.getElementById('challenge-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');

            document.getElementById('detail-content-area').innerHTML = `
                <div class="mb-12">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-[10px] mono font-bold px-2 py-0.5 border border-emerald-500/30 text-emerald-500 uppercase tracking-widest italic">${chal.category}</span>
                        <span class="text-[10px] mono text-gray-600 font-bold uppercase tracking-widest">${chal.level}</span>
                    </div>
                    <h1 class="text-5xl font-extrabold text-white tracking-tighter italic mb-4 uppercase">${chal.title}</h1>
                    <div class="h-px w-20 bg-emerald-500"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    <div class="lg:col-span-2 space-y-8">
                        <div class="content-box p-10 min-h-[300px]">
                            <h2 class="text-[11px] mono text-gray-500 uppercase tracking-widest mb-8 font-bold">// SYSTEM_LOG</h2>
                            <div class="text-gray-400 leading-relaxed text-lg whitespace-pre-wrap">${chal.content}</div>
                        </div>
                        ${chal.file_url ? `<a href="${chal.file_url}" target="_blank" class="inline-flex items-center gap-3 px-6 py-3 border border-main text-[10px] mono text-white hover:border-emerald-500 transition-all uppercase font-bold bg-[#0f0f0f]">Download Attachment</a>` : ''}
                    </div>
                    <div class="space-y-6">
                        <div class="content-box p-8">
                            <h4 class="text-[10px] mono text-emerald-500 uppercase tracking-widest mb-6 font-bold italic">Auth_Portal</h4>
                            ${isSolved ? 
                                `<div class="py-4 text-center border border-emerald-900 bg-emerald-900/10 rounded mono text-emerald-400 text-[10px] font-bold uppercase tracking-widest">ACCESS_GRANTED: ALREADY_BREACHED</div>` :
                                `<input type="text" id="flag-input" placeholder="FLAG{...}" class="w-full px-4 py-3 rounded input-field text-sm mono mb-4">
                                <button id="submit-btn-real" class="w-full bg-white text-black py-4 rounded font-black text-[11px] uppercase tracking-widest hover:bg-emerald-500 hover:text-white transition-all">Execute_Exploit</button>`
                            }
                        </div>
                    </div>
                </div>`;

            if (!isSolved && user) {
                document.getElementById('submit-btn-real').onclick = async () => {
                    const input = document.getElementById('flag-input').value;
                    if (input === chal.flag) {
                        const { data: already } = await _supabase.from('solvers_log').select('*').eq('user_id', user.id).eq('challenge_id', chal.id).single();
                        if (already) return alert("ALREADY BREACHED.");

                        await _supabase.from('solvers_log').insert([{ user_id: user.id, challenge_id: chal.id }]);
                        const { data: p } = await _supabase.from('profiles').select('points').eq('id', user.id).single();
                        await _supabase.from('profiles').update({ points: p.points + chal.points }).eq('id', user.id);
                        await _supabase.from('challenges').update({ solvers: (chal.solvers || 0) + 1 }).eq('id', chal.id);
                        
                        alert("SUCCESS: Database Breached.");
                        switchTab('challenge');
                    } else { alert("ERROR: Access Denied."); }
                };
            }
        }

        async function fetchRanking() {
            const { data: ranks } = await _supabase.from('profiles').select('nickname, points').order('points', { ascending: false }).limit(20);
            document.getElementById('ranking-body').innerHTML = ranks.map((u, i) => `
                <tr class="rank-row border-b border-main/50">
                    <td class="px-8 py-5 text-sm mono text-gray-500 font-bold tracking-tighter">${(i + 1).toString().padStart(2, '0')}</td>
                    <td class="px-8 py-5 text-sm font-bold text-white uppercase italic tracking-tight">${u.nickname}</td>
                    <td class="px-8 py-5 text-sm font-black text-emerald-500 mono text-right">${u.points.toLocaleString()} PT</td>
                </tr>`).join('');
        }

        switchTab('challenge');
    </script>
</body>
</html>
