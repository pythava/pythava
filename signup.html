<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYTHAVA | Sign Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #d1d5db; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .input-field { background-color: #0f0f0f; border: 1px solid #1f2937; transition: all 0.2s; color: white; }
        .input-field:focus { border-color: #3b82f6; outline: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <nav class="border-b border-[#1f2937] h-16 flex items-center px-6 justify-between bg-[#0a0a0a]/80 backdrop-blur-md">
        <a href="/" class="text-white font-extrabold text-xl tracking-tighter">PYTHAVA</a>
        <a href="/login" class="text-[11px] font-bold text-gray-400 hover:text-white mono">BACK_TO_LOGIN</a>
    </nav>

    <main class="flex-1 flex items-center justify-center px-6 py-12">
        <div class="w-full max-w-[400px]">
            <div class="text-center mb-8">
                <h2 class="text-white font-extrabold text-2xl tracking-tight">Create Identity</h2>
                <p class="text-[11px] mono text-gray-600 mt-2 uppercase tracking-[0.3em]">Join the security network</p>
            </div>

            <div class="border border-[#1f2937] rounded-lg p-8 bg-[#0a0a0a]">
                <form id="signup-form" class="space-y-5">
                    <div>
                        <label class="block text-[10px] mono text-gray-500 uppercase tracking-widest mb-2">Nickname</label>
                        <input type="text" id="nickname" required class="w-full px-4 py-3 rounded input-field text-sm" placeholder="Your_Handle">
                    </div>
                    <div>
                        <label class="block text-[10px] mono text-gray-500 uppercase tracking-widest mb-2">Email Address</label>
                        <input type="email" id="email" required class="w-full px-4 py-3 rounded input-field text-sm" placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-[10px] mono text-gray-500 uppercase tracking-widest mb-2">Password</label>
                        <input type="password" id="password" required class="w-full px-4 py-3 rounded input-field text-sm" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-bold text-xs uppercase tracking-widest hover:bg-blue-500 transition-all">
                        Create Account
                    </button>
                </form>
            </div>
        </div>
    </main>

    <script>
        const SB_URL = "https://udcsxjtnnrxolwmavyqo.supabase.co";
        const SB_KEY = "sb_publishable_q_NjT8knSzwiL7TOOajWYg_5FN1zIZp";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        document.getElementById('signup-form').onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const nickname = document.getElementById('nickname').value;
    
        // 1. 회원가입 시도
        const { data, error } = await _supabase.auth.signUp({
            email,
            password
        });
    
        if (error) {
            alert("Sign Up Error: " + error.message);
            return;
        }
    
        if (data.user) {
            // upsert는 데이터가 있으면 'Update', 없으면 'Insert'를 수행하므로 23505 에러가 발생하지 않습니다.
            const { error: profileError } = await _supabase
                .from('profiles')
                .upsert({ 
                    id: data.user.id, 
                    email: email, 
                    nickname: nickname, 
                    points: 0 
                });
        
            if (profileError) {
                // upsert 환경에서 에러가 났다면 RLS(보안정책) 위반이나 데이터 형식 오류일 확률이 높습니다.
                console.error("Profile Logic Error:", profileError.message);
                alert("프로필 생성 중 오류가 발생했습니다: " + profileError.message);
                return; // 에러가 발생하면 다음 단계(로그인 이동)로 넘어가지 않음
            }
            
            alert("회원가입이 완료되었습니다!");
            location.href = '/index.html';
        }
    };
        // 페이지가 열리자마자 실행되어야 함
        async function init() {
            const { data: { user } } = await _supabase.auth.getUser();
            const navAuth = document.getElementById('nav-auth-section');
        
            if (user) {
                // 유저 정보가 있으면 'LOG IN' 버튼 대신 닉네임 표시
                const { data: profile } = await _supabase
                    .from('profiles')
                    .select('nickname')
                    .eq('id', user.id)
                    .single();
        
                navAuth.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-white text-[11px] font-bold mono">${profile?.nickname || 'USER'}</span>
                        <button id="logout-btn" class="text-[10px] text-gray-600 hover:text-white underline">LOGOUT</button>
                    </div>
                `;
        
                document.getElementById('logout-btn').onclick = async () => {
                    await _supabase.auth.signOut();
                    location.reload();
                };
            }
        }
        init();
    </script>
</body>
</html>
